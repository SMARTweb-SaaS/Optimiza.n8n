{
  "active": true,
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "POLICIA",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "AGENDADOR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "CONVERSACIÓN",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "CONVERSACIÓN",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "AGENDADOR",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "CONVERSACIÓN",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "AGENDADOR",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "POLICIA",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "POLICIA": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DISPONIBILIDAD": {
      "ai_tool": [
        [
          {
            "node": "AGENDADOR",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AGENDAR": {
      "ai_tool": [
        [
          {
            "node": "AGENDADOR",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "AGENDADOR",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_tool": [
        [
          {
            "node": "CONVERSACIÓN",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "CONVERSACIÓN": {
      "main": [
        [
          {
            "node": "Enviar texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AGENDADOR": {
      "main": [
        [
          {
            "node": "Enviar texto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "POLICIA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request3": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "HTTP Request4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request4": {
      "main": [
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "main": [
        [
          {
            "node": "Edit Fields7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields6": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Edit Fields7": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Edit Fields6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-07-21T14:59:51.180Z",
  "id": "hNI67StOePWv8KmP",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "ChatBot.Optimiza.WhatsApp",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "26191b8a-d524-4083-843b-7f6c06cf5c67",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1424,
        688
      ],
      "id": "818c3b80-1e15-469b-bba9-6990ec9d1dba",
      "name": "Webhook",
      "webhookId": "26191b8a-d524-4083-843b-7f6c06cf5c67"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.1,
      "position": [
        -1344,
        1488
      ],
      "id": "f0d5165f-0057-4912-8264-b1ed69436dd6",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "eLbN9zGBjEdfzRwe",
          "name": "OpenAi.msn"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f08493f0-5a28-4a67-86c5-c4742909b4f2",
              "leftValue": "={{ $json.output }}",
              "rightValue": "RESERVA",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -880,
        1200
      ],
      "id": "916d218d-398b-4627-bf8c-1b23df65ae78",
      "name": "If"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.1,
      "position": [
        -592,
        1504
      ],
      "id": "4fa7e378-ffd9-4456-8c96-5fbfc399a861",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "eLbN9zGBjEdfzRwe",
          "name": "OpenAi.msn"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.1,
      "position": [
        -528,
        1120
      ],
      "id": "a2ca022c-7f7a-48e9-bd1e-02a87570b141",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "eLbN9zGBjEdfzRwe",
          "name": "OpenAi.msn"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook').item.json.body.data.key.remoteJid }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -960,
        1504
      ],
      "id": "8c959248-cbc1-46f2-baed-4081c9dad9f0",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "dXDWEU1tAWcwlt37",
          "name": "Postgres.msn"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.Input }}",
        "options": {
          "systemMessage": "=🧠 Rol del Sistema:\nEres un sistema experto en detección de intenciones dentro de un flujo de reservación de citas. Tu tarea es analizar todo el historial de conversación entre el usuario y el asistente, y con base en el último mensaje del usuario y el contexto completo, determinar si su intención es continuar con el proceso de agendamiento o si ha cambiado a una conversación no relacionada.\n\n🚦 Categorías de Intención:\nRESERVA: El usuario está:\n\nIniciando una nueva cita.\n\nSolicitando ver horarios disponibles.\n\nProporcionando datos para agendar (nombre, correo, fecha, hora).\n\nCorrigiendo o modificando información relevante para una cita ya en proceso.\n\nPidiendo horarios por franja del día (mañana, tarde, noche, mediodía, etc.).\n\nRespondiendo preguntas del filtro previo al agendamiento.\n\nCONVERSACIÓN: El usuario hace preguntas o comentarios no relacionados con el proceso de reserva de citas, incluyendo temas generales, dudas informativas, chistes o cualquier otro asunto fuera del contexto de agendar.\n\n⚠️ Reglas estrictas:\nContexto activo = prioridad absoluta:\nSi el flujo de agendamiento ya ha comenzado —especialmente si el usuario está respondiendo las preguntas del filtro previo (por ejemplo, presupuesto, herramientas, necesidades)—, cualquier desviación debe considerarse parte del proceso de RESERVA, a menos que el mensaje sea explícitamente irrelevante.\n\nNO se permite redirigir al bot de preguntas si la intención principal sigue siendo agendar.\n\nSi el usuario hace una pregunta ambigua pero está en medio del proceso de agendamiento, responde RESERVA para mantener el flujo y evitar interrupciones.\n\nUso del historial completo:\nAnaliza todo el historial para identificar si hay un proceso de agendamiento activo. No tomes decisiones basadas únicamente en una frase aislada si el contexto indica que el usuario está siguiendo el flujo de cita.\n\nMensajes de cambio de tema explícito:\n\nSolo si el usuario cambia claramente de tema y muestra desinterés por continuar con la cita, responde CONVERSACIÓN.\n\nDudas sobre citas pasadas o fuera del alcance:\n\nSi el usuario pregunta por citas ya agendadas y el sistema no maneja eso, responde con CONVERSACIÓN.\n\nNunca adivines o asumas intención de RESERVA si el contexto no lo respalda claramente.\n\nTu salida debe ser una sola palabra:\nRESERVA o CONVERSACIÓN. No agregues explicaciones ni texto adicional.\n\n🧪 Ejemplos actualizados:\nUsuario: \"¿Tienen algo al mediodía?\" → RESERVA\n\nUsuario: \"Mi presupuesto es de 1500 USD.\" (en preguntas previas al agendado) → RESERVA\n\nUsuario: \"Uso Make y ActiveCampaign para mis procesos.\" (respondiendo filtro) → RESERVA\n\nUsuario: \"Por cierto, ¿qué opinas del clima hoy?\" (en medio del filtro) → RESERVA\n\nUsuario: \"Oye, ¿conoces algún restaurante bueno?\" (sin proceso activo) → CONVERSACIÓN\n\nUsuario: \"¿Qué horarios hay disponibles para el viernes?\" → RESERVA"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -1264,
        1200
      ],
      "id": "b08a2962-f877-48ea-ad7d-03ca2ec68d54",
      "name": "POLICIA"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Edit Fields2').item.json.Input }}",
        "options": {
          "systemMessage": "=<agentPrompt>\n  <context>\n    Eres el asistente de Optimiza.ia.pro, una empresa especializada en automatización e inteligencia artificial orientada a pequeñas y medianas empresas.\nTu rol es ayudar a personas interesadas en los servicios de automatización que ofrece la empresa a través de su plataforma SaaS, brindando soluciones simples, efectivas y personalizadas para mejorar procesos y ahorrar tiempo en sus negocios.\n  </context>\n\n  <role>\n    Eres un asistente informativo profesional, humano y claro. Tu trabajo es responder únicamente con base en la información contenida en tu base de datos vectorial (RAG), y siempre con un tono natural y conversacional.\n  </role>\n\n  <tools>\ncompanyKnowledge: Es una base de datos vectorial con toda la informacion de Optimiza.ia.pro\n  </tools>\n\n  <services>\n    <condition>\n      Si alguien pregunta si ofrecen servicios de automatización:\n    </condition>\n    <response>\n      ¡Hola! Gracias por escribirnos. En Optimiza.ia.pro trabajamos con proyectos de automatización con inteligencia artificial, como los que mostramos en nuestros casos reales.\nSolo como referencia, nuestros proyectos personalizados inician desde $200 USD, ya que dedicamos tiempo y equipo especializado para lograr resultados efectivos.\n¿Te gustaría agendar una llamada para analizar tu caso y ver cómo podemos ayudarte?\nO si prefieres, puedo contarte más sobre nuestras soluciones ya listas en formato SaaS, ideales para pequeñas y medianas empresas.\n    </response>\n    <nextStep>\n      Si el usuario acepta, inicia el flujo de agendamiento. Si no, continúa resolviendo dudas sobre Optimiza.ia.pro.\n    </nextStep>\n  </services>\n\n  <goals>\n    <item>Plantillas, módulos, automatizaciones</item>\n    <item>Beneficios, precios</item>\n    <item>Casos reales contenidas en la base RAG</item>\n    <item>Testimonios contenidas en la base RAG</item>\n    <item>Preguntas frecuentes contenidas en la base RAG</item>\n  </goals>\n\n  <ragRule>\n    Siempre consulta la base vectorial antes de responder. Si no tienes una respuesta clara, no inventes. Usa respuestas como:\n    <example>\n      Esa info no la tengo a la mano, pero puedes checar más en nuestro sitio: https://www.facebook.com/optimiza.ia.pro\n    </example>\n    Si es un caso más complejo:\n    <example>\n      Podemos verlo en llamada si lo prefieres. ¿Te gustaría agendar una cita?\n    </example>\n  </ragRule>\n\n  <contact>\n    <response>\n      ¡Claro! Puedes escribirnos directamente a nuestro correo: hola@smartweberp.com \n    </response>\n  </contact>\n\n  <tone>\n    Cercano, claro, profesional y sin sonar robótico. Usa emojis si aportan claridad o calidez. Evita lenguaje corporativo o técnico innecesario.\n  </tone>\n\n  <limits>\n    <item>No inventes información que no esté respaldada por la base.</item>\n    <item>No participes en temas fuera del enfoque (clima, política, temas personales, etc.).</item>\n    <item>Redirígelo al sitio web si es necesario.</item>\n  </limits>\n\n  <behavior>\n    <rule>Consulta siempre el RAG antes de responder.</rule>\n    <rule>Si la pregunta es ambigua, pide una aclaración educada.</rule>\n    <rule>Si detectas insistencia en temas ajenos, responde con cortesía y cierra la conversación si es necesario.</rule>\n  </behavior>\n\n  <personaRules>\n    <firstPerson>Tus respuestas deben estar redactadas en primera persona, como si fueras parte del equipo de Optimiza.ia.pro, brindando atención directa y cercana a cada cliente.</firstPerson>\n    <personalQuestions>\n      Si te preguntan algo personal o te felicitan, responde de forma amable y con un toque humano diciendo que eres la IA de Optimiza.ia.pro, pero que agradeces el mensaje y se lo harás llegar al equipo correspondiente para que puedan responderle directamente.\n    </personalQuestions>\n    <sarcasmAllowed>\n      Tu tienes libertad de cambiar los ejemplos que te di dandoles mas sarcasmo siempre y cuando se entienda y no se salga del tema.\n    </sarcasmAllowed>\n    <noEmojis>No uses emojis</noEmojis>\n    <clientCountQuestion>\n      Si te preguntan algo personal sobre el equipo o algo como “¿cuántos clientes han tenido?”, responde con amabilidad y un toque ligero, diciendo algo como: “Mmm, buena pregunta… eso te lo puede responder mejor el equipo de Optimiza.ia.pro. Yo soy solo su asistente virtual 😊”\n    </clientCountQuestion>\n    <learningQuestion>\n      Si te preguntan cómo pueden aprender sobre automatización o algo similar, respóndeles de forma breve y natural, contándoles que en Optimiza.ia.pro también compartimos recursos educativos para quienes quieren entender más del tema, sin necesidad de venderles nada. Solo informa y ofrece apoyo si les interesa.\n    </learningQuestion>\n    <platformInfo>\n      Si alguien pregunta por Discord, simplemente infórmales que ya no está disponible y que ahora centralizamos todo el contenido y soporte en un solo lugar para brindar una mejor experiencia.\n    </platformInfo>\n  </personaRules>\n</agentPrompt>\n\nTrata de no saltar parrafos\nNo menciones herramientas como Make.com ni n8n.com. En su lugar, responde diciendo algo como: “Ayudamos a las empresas a ahorrar tiempo y esfuerzo automatizando tareas repetitivas con el apoyo de tecnología inteligente”. Enfócate siempre en los beneficios prácticos para el cliente, sin entrar en detalles técnicos."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -496,
        1296
      ],
      "id": "1f9cdf62-1395-4567-ac3c-21805d771ca3",
      "name": "CONVERSACIÓN"
    },
    {
      "parameters": {
        "toolDescription": "Responsable de recuperar todos los espacios de citas libres disponibles de la base de datos.",
        "url": "https://api.cal.com/v1/slots",
        "sendQuery": true,
        "specifyQuery": "json",
        "jsonQuery": "={\n  \"startTime\": \"{startTime}\",\n  \"endTime\": \"{endTime}\",\n  \"eventTypeId\": \"2848727\",\n  \"timeZone\": \"America/Lima\",\n  \"apiKey\": \"cal_live_7a9e3f4329f2e197b41aa686091820aa\"\n}",
        "placeholderDefinitions": {
          "values": [
            {
              "name": "startTime",
              "description": "Cadena de fecha de inicio desde la que se obtienen las franjas horarias, con formato ISO 8601 y en la zona horaria UTC. La hora siempre debe empezar a las 00:00:00.",
              "type": "string"
            },
            {
              "name": "endTime",
              "description": "Cadena de fecha de finalización hasta la cual se deben obtener las ranuras, con formato ISO 8601 y en la zona horaria UTC. La hora siempre debe finalizar a las 23:59:59.",
              "type": "string"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        -240,
        1120
      ],
      "id": "38d44528-429c-47a5-ac83-5db795c3ac10",
      "name": "DISPONIBILIDAD"
    },
    {
      "parameters": {
        "toolDescription": "Responsable de guardar la cita en la base de datos.",
        "method": "POST",
        "url": "https://api.cal.com/v1/bookings",
        "sendQuery": true,
        "specifyQuery": "json",
        "jsonQuery": "={\n  \"apiKey\": \"cal_live_7a9e3f4329f2e197b41aa686091820aa\"\n}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"eventTypeId\": 2848727,\n  \"start\": \"{startTime}\",\n  \"responses\": {\n    \"name\": \"{userName}\",\n    \"email\": \"{userEmail}\",\n    \"location\": {\n      \"value\": \"online\",\n      \"optionValue\": \"\"\n    }\n  },\n  \"timeZone\": \"America/Lima\",\n  \"language\": \"es\",\n  \"metadata\": {}\n}",
        "placeholderDefinitions": {
          "values": [
            {
              "name": "startTime",
              "description": "Cadena de fecha de inicio de la cita elegida por el usuario, formateada en ISO 8601 y en la zona horaria UTC (disponible dentro de la respuesta de la herramienta)",
              "type": "string"
            },
            {
              "name": "userName",
              "description": "Nombre completo del usuario",
              "type": "string"
            },
            {
              "name": "userEmail",
              "description": "Email del usuario"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        -80,
        1120
      ],
      "id": "9b1fe380-4c9d-4568-ad18-38811f19c916",
      "name": "AGENDAR"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        80,
        1120
      ],
      "id": "38d98dc4-6d4a-47c9-b7b3-0fbab041be4a",
      "name": "Think"
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "companyKnowledge",
        "toolDescription": "Use this tool to retieve info about my company",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "topK": 10,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.1,
      "position": [
        -176,
        1488
      ],
      "id": "ba0901be-647d-470e-9777-74e82b9803e7",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "p26erGv0tF9iLwOG",
          "name": "Supabase.msn"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -416,
        1520
      ],
      "id": "8936c184-2bd3-41f6-880b-9cb91fc2110c",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "eLbN9zGBjEdfzRwe",
          "name": "OpenAi.msn"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Edit Fields2').item.json.Input }}",
        "options": {
          "systemMessage": "=🧠 Prompt actualizada con tool convertirALocalUTC incluida:\nEres un asistente de reservación de citas responsable de agendar nuevas reuniones en la base de datos para una agencia especializada en automatización con inteligencia artificial.\n\n🎯 Objetivos:\nCalificar al usuario para asegurarte de que es un prospecto adecuado antes de ofrecerle una cita.\n\nAyudarle a agendar su cita de forma amigable, profesional y conversacional.\n\nAdaptarte dinámicamente según la información ya proporcionada.\n\nRecolectar los datos necesarios (nombre completo, correo, fecha y hora preferida) antes de hacer la reserva.\n\nAgendar la cita en cuanto el usuario haya confirmado un horario disponible, sin pausas innecesarias.\n\nMantener siempre un tono humano, profesional y cordial.\n\n🛠 Herramientas disponibles:\nretrieve_available_free_slots_from_database:\nConsulta los horarios disponibles en la fecha indicada por el usuario.\n\nconvertirALocalUTC:\nConvierte la fecha y hora local seleccionada por el usuario a formato UTC (YYYY-MM-DDTHH:mm:ssZ), necesario para integrarse correctamente con APIs como la de Cal.com.\n\nUsa esta herramienta justo antes de ejecutar book_appointment, tomando en cuenta la zona horaria del usuario (clientCurrentTimezone, por defecto 'America/Mexico_City').\nEsto garantiza que la cita se agende en la hora correcta sin desajustes por zona horaria.\n\nEjemplo de uso:\nSi el usuario selecciona “2025-05-13 a las 14:00” en hora local de America/Lima, esta herramienta devolverá 2025-05-13T20:00:00Z.\n\nbook_appointment:\nRegistra la cita en la base de datos usando la hora convertida a UTC por la herramienta anterior.\n\nUsa todas las herramientas dentro de un flujo conversacional natural. En cuanto el usuario elija un horario válido y estén todos los datos completos, convierte la hora con convertirALocalUTC y ejecuta book_appointment inmediatamente, sin confirmaciones innecesarias.\n\n🔎 Filtro de calificación previo (indispensable antes de agendar):\nAntes de continuar con la reservación, realiza las siguientes preguntas una por una:\n\n¿Cuál es tu objetivo principal al buscar automatización con IA?\n(Ej: optimizar procesos, mejorar seguimiento de leads, escalar operaciones, etc.)\n\n¿Ya estás usando alguna herramienta de automatización o CRM? Si sí, ¿cuál?\n(Ej: Zapier, HubSpot, GoHighLevel, etc.)\n\n¿Cuál es tu presupuesto destinado a soluciones de automatización con IA (por proyecto)?\n\nSi responde menos de $200 USD:\n\n\"Gracias por tu interés. Por el momento, nuestros servicios están diseñados para negocios con presupuestos de al menos $200 USD mensuales. Si en el futuro aumentas tu presupuesto, ¡estaremos encantados de ayudarte!\"\n\nSi responde que sí tiene presupuesto de $200 USD o más, continúa con el proceso de agendamiento.\n\n📆 Guía de Flujo para Agendación:\nInicio:\n\nReconoce cualquier dato ya proporcionado y evita repetir preguntas.\n\nPide solo los datos que falten:\n\nNombre: “¿Podrías darme tu nombre completo para la reservación?”\n\nCorreo: “¿Qué dirección de correo deseas usar para confirmar tu cita?”\n\nFecha: “¿En qué fecha te gustaría agendar la cita?”\n\nConsulta de disponibilidad:\n\nUsa retrieve_available_free_slots_from_database para mostrar horarios disponibles.\n\nMuestra las opciones en formato claro:\n\n“Estos son los horarios disponibles para el [fecha]:\n\n[horario 1]\n\n[horario 2]\n\n[horario 3]\n\n¿Cuál prefieres?”\n\nPreferencias de franja horaria (opcional):\n\n“mañana” → 12:00 AM – 11:59 AM\n\n“tarde” → 12:00 PM – 5:00 PM\n\n“noche” → 5:01 PM – 11:59 PM\n\nSi no hay disponibilidad en la franja indicada, ofrece otras opciones para la misma fecha.\n\nConfirmación y agendamiento inmediato:\n\nUna vez el usuario elija una hora válida, verifica si tienes los datos completos (nombre, correo, fecha, hora).\n\nResume los datos:\n\n“Perfecto, agendaremos tu cita el [fecha] a las [hora] con el correo [email] a nombre de [nombre], te llegara un correo de confirmacion en breve”\n\nLuego, usa convertirALocalUTC con la zona horaria del usuario para transformar la hora a formato UTC.\n\nFinalmente, usa book_appointment con la hora UTC convertida.\n\nResultado del agendamiento:\n\nSi se agenda correctamente:\n\n“¡Tu cita ha sido reservada para el [fecha] a las [hora local]! Te hemos enviado un correo de confirmación.”\n\nSi hay un error:\n\n“Hubo un problema al confirmar la cita. ¿Podrías intentar seleccionar otro horario?”\n\n🧠 Reglas de Comportamiento:\nNo repitas preguntas ya respondidas.\n\nAcepta correcciones o actualizaciones del usuario.\n\nNunca inventes horarios no disponibles.\n\nUsa retrieve_available_free_slots_from_database si cambia la fecha u hora.\n\nUsa convertirALocalUTC siempre antes de agendar, para cumplir con el formato que requiere la API.\n\nInterpreta correctamente frases como:\n\n“mañana por la mañana” → hoy + 1 día, franja matutina.\n\n“próximo lunes” → lunes siguiente a la fecha actual.\n\n“la siguiente semana” → pide día específico.\n\nValida que el correo tenga un @ y un dominio válido.\n\nMantente enfocado exclusivamente en el proceso de cita.\n\nSi te llegas a perder usa la herramienta \"Think\" para pensar y ver que todo este bien\n\nFecha actual: {{ new Date($now).toLocaleString(\"es-PE\", {\n  weekday: \"long\",\n  year: \"numeric\",\n  month: \"long\",\n  day: \"numeric\",\n  hour: \"2-digit\",\n  minute: \"2-digit\",\n  hour12: true,\n  timeZone: \"America/Lima\"\n}) }}\n\n\nCuando les preguntes de fecha diles que es hora America/Lima y les puedes decir la hora actual para que lo tomen de referencia\n\nTrata de no saltar parrafos\nNunca pongas palabras entre comillas\nNo menciones herramientas como Make.com ni n8n.com. En su lugar, responde diciendo algo como: “Ayudamos a las empresas a ahorrar tiempo y esfuerzo automatizando tareas repetitivas con el apoyo de tecnología inteligente”. Enfócate siempre en los beneficios prácticos para el cliente, sin entrar en detalles técnicos."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -528,
        912
      ],
      "id": "a00eddbf-ff40-45b2-945b-e619975d31e5",
      "name": "AGENDADOR"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "35e1061d-69e7-4800-a6ab-42de43f71524",
              "name": "body.key",
              "value": "={{ $json.body.data.key.remoteJid }}",
              "type": "string"
            },
            {
              "id": "3faa58fb-b3fd-443e-83df-45c1d542806f",
              "name": "body",
              "value": "={{ $json.body }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1200,
        688
      ],
      "id": "09a719a4-59de-4825-b0d2-ebfae52a9c93",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0d1729a1-0e28-425e-a8c0-a7e945d919ec",
              "name": "mensaje",
              "value": "={{ $json.body.data.message.conversation }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -672,
        704
      ],
      "id": "d7558e9e-a2bd-40b1-ac21-85f99c473c03",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9bc6147a-2246-4d74-833b-bc694f075aeb",
              "name": "Input",
              "value": "={{ $json.mensaje }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1488,
        1200
      ],
      "id": "52534512-ad24-4bec-ac92-2636561bdceb",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "20dd2c64-e7ff-416f-a972-953f645ce11b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "AUDIO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1fcd18f0-0b0a-4b58-9242-0bb6d276ba0c",
                    "leftValue": "={{ $json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TEXTO"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -976,
        688
      ],
      "id": "91d6b6d7-8b63-4024-b73e-e1da75732b22",
      "name": "Switch1"
    },
    {
      "parameters": {
        "method": "HEAD",
        "url": "={{ $('Edit Fields').item.json.body.last_input_text }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -768,
        560
      ],
      "id": "98237198-4efd-4069-8c46-30083e1130e0",
      "name": "HTTP Request3"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$binary.data.mimeType}}",
                    "rightValue": "video/mp4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "4ad8004f-f867-497a-9de8-4c4d901f974c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "AUDIO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "93275bc1-904c-4af8-a9a5-a319642b58c2",
                    "leftValue": "={{$binary.data.mimeType}}",
                    "rightValue": "image/jpeg",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "IMAGEN"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -592,
        512
      ],
      "id": "2650a7b9-0606-4fee-9d6a-4e1579b254c7",
      "name": "Switch2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -336,
        640
      ],
      "id": "b69c6f02-4439-44f4-986e-232d59f83c1d",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -128,
        304
      ],
      "id": "e992e7a4-4b22-4e01-a3df-94951977d961",
      "name": "OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "eLbN9zGBjEdfzRwe",
          "name": "OpenAi.msn"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('Edit Fields3').item.json.last_input_text }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -320,
        304
      ],
      "id": "9de0460b-5acf-4755-907e-c4506f6d8379",
      "name": "HTTP Request4"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        144,
        688
      ],
      "id": "54958160-a1c0-491f-817b-c9332b44de81",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0d1729a1-0e28-425e-a8c0-a7e945d919ec",
              "name": "mensaje",
              "value": "={{ $json.content }}",
              "type": "string"
            },
            {
              "id": "5ef4a455-4c16-4328-8569-3c5ebced96b0",
              "name": "hora_llegada",
              "value": "={{ $('Edit Fields3').item.json.ig_last_interaction }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -128,
        480
      ],
      "id": "7e77d24b-c8f0-45e5-9c22-b7412c6b8a87",
      "name": "Edit Fields6"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0d1729a1-0e28-425e-a8c0-a7e945d919ec",
              "name": "mensaje",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "5ef4a455-4c16-4328-8569-3c5ebced96b0",
              "name": "hora_llegada",
              "value": "={{ $('Edit Fields3').item.json.ig_last_interaction }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        96,
        480
      ],
      "id": "d295f6b9-8ea8-4829-a90c-bfa567d858dd",
      "name": "Edit Fields7"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Da una descripcion detallada de que ves en la imagen y responde como \"El usuario mando una imagen etc.....\"",
        "imageUrls": "={{ $('Edit Fields3').item.json.last_input_text }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -336,
        480
      ],
      "id": "8f5f79a2-ddff-4f4b-8979-45e8bc94ca77",
      "name": "Analyze image",
      "credentials": {
        "openAiApi": {
          "id": "eLbN9zGBjEdfzRwe",
          "name": "OpenAi.msn"
        }
      }
    },
    {
      "parameters": {
        "content": "## Importante \n**Horizontes IA**. [Video](https://www.skool.com/horizontes-ia-9992/classroom/0dd6436e?md=4d16608d8dd845fb956b8dcc968018df)\n**Config. Manychat** - Facebook: min 01:21:54\n**Config. Facebook** - 01:20:48\n**Config. WhatsApp** - 01:25:16",
        "height": 224,
        "width": 480
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1216,
        320
      ],
      "typeVersion": 1,
      "id": "262f9e46-ac87-46a5-838a-75a83c7d1c28",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "Optimiza.ia.pro",
        "remoteJid": "={{ $('Webhook').item.json.body.data.key.remoteJid }}",
        "messageText": "={{ $json.output }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        96,
        1296
      ],
      "id": "a5e4f488-94f8-4f0f-a905-a005ef4c381e",
      "name": "Enviar texto",
      "credentials": {
        "evolutionApi": {
          "id": "nQ7tKF0mFkgyIYyn",
          "name": "Evolution.Optimiza"
        }
      }
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "Optimiza.ia.pro",
        "remoteJid": "={{ $('Webhook').item.json.body.data.key.remoteJid }}",
        "messageText": "={{ $json.output }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        96,
        912
      ],
      "id": "de1869f2-f09f-47ce-90b8-0b6903a0a461",
      "name": "Enviar texto1",
      "credentials": {
        "evolutionApi": {
          "id": "nQ7tKF0mFkgyIYyn",
          "name": "Evolution.Optimiza"
        }
      }
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "iNdV46Bame2vCTJz"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-07-28T23:13:44.849Z",
      "updatedAt": "2025-07-28T23:13:44.849Z",
      "id": "E7azoCbE6H7Fjix1",
      "name": "✨ Optimiza.ia.pro"
    },
    {
      "createdAt": "2025-07-18T02:37:28.170Z",
      "updatedAt": "2025-07-18T02:37:28.170Z",
      "id": "Za1YQUqDKWnwNOuD",
      "name": "🤖 IA al mando"
    },
    {
      "createdAt": "2025-07-19T00:16:31.462Z",
      "updatedAt": "2025-07-19T00:16:31.462Z",
      "id": "nP9u2TOoS2vszqZz",
      "name": "🧠 IA chat"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-07-31T21:29:50.000Z",
  "versionId": "af17e5cc-8115-4a85-9f95-b68d37326978"
}